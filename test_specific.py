#!/usr/bin/env python3
"""
–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è Inmuebles24 ‚Üí WhatsApp Bot
"""

import os
from dotenv import load_dotenv

load_dotenv()

def test_inmuebles24_scenario():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Å Inmuebles24"""
    print("üè† –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–¶–ï–ù–ê–†–ò–Ø INMUEBLES24")
    print("=" * 60)
    
    # –†–µ–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
    incoming_message = """¬°Hola! Quiero que se comuniquen conmigo por este inmueble en Inmuebles24 https://www.inmuebles24.com/propiedades/clasificado/veclcapa-hermosa-casa-en-residencial-rio-cancun-146144201.html"""
    
    print(f"üì± –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:")
    print(f"   {incoming_message}")
    print()
    
    try:
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–µ—Ç–µ–∫—Ü–∏—é –ª–∏–¥–∞
        from core.lead_detector import lead_detector
        
        print("üéØ –î–ï–¢–ï–ö–¶–ò–Ø –õ–ò–î–ê:")
        lead_result = lead_detector.analyze_message(incoming_message)
        print(f"   –≠—Ç–æ –ª–∏–¥? {lead_result.get('is_lead', False)}")
        print(f"   –¢–∏–ø –∏–Ω—Ç–µ—Ä–µ—Å–∞: {lead_result.get('interest', 'none')}")
        print(f"   –£–ø–æ–º—è–Ω—É—Ç—ã–µ –æ–±—ä–µ–∫—Ç—ã: {lead_result.get('property_mentions', [])}")
        print()
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç RAG —Å–∏—Å—Ç–µ–º—ã
        from core.llm_chain import llm_chain
        
        print("ü§ñ –û–¢–í–ï–¢ RAG –°–ò–°–¢–ï–ú–´:")
        rag_response = llm_chain.invoke_chain(incoming_message, [])
        print(f"   –û—Ç–≤–µ—Ç: {rag_response}")
        print()
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–±–ª–µ–º—ã
        print("‚ö†Ô∏è  –í–´–Ø–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:")
        
        # –ü—Ä–æ–±–ª–µ–º–∞ 1: –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
        if "inmuebles24.com" in incoming_message.lower():
            print("   ‚ùå –ö–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± –æ–±—ä–µ–∫—Ç–µ —Å Inmuebles24")
            print("   ‚ùå –£ –Ω–∞—Å –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ —Å century21apolo.com")
            print("   ‚ùå RAG —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–Ω–∞–µ—Ç —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç")
        
        # –ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏
        print("   ‚ùå –ù–µ—Ç –º–∞–ø–ø–∏–Ω–≥–∞ –º–µ–∂–¥—É Inmuebles24 –∏ –Ω–∞—à–µ–π –±–∞–∑–æ–π")
        print("   ‚ùå –ë–æ—Ç –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, –∫–∞–∫–æ–π –æ–±—ä–µ–∫—Ç –∏–∑ –Ω–∞—à–µ–π –±–∞–∑—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–ø—Ä–æ—Å—É")
        
        return True
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        return False

def suggest_solutions():
    """–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º"""
    print("\nüí° –ü–†–ï–î–õ–ê–ì–ê–ï–ú–´–ï –†–ï–®–ï–ù–ò–Ø:")
    print("=" * 60)
    
    print("üîß –†–ï–®–ï–ù–ò–ï 1: –£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫")
    print("   ‚Ä¢ –ò–∑–≤–ª–µ–∫–∞—Ç—å –∞–¥—Ä–µ—Å/—Ä–∞–π–æ–Ω –∏–∑ —Å—Å—ã–ª–∫–∏ Inmuebles24")
    print("   ‚Ä¢ –ò—Å–∫–∞—Ç—å –ø–æ—Ö–æ–∂–∏–µ –æ–±—ä–µ–∫—Ç—ã –≤ –±–∞–∑–µ Century 21 Apolo")
    print("   ‚Ä¢ –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: '–£ –Ω–∞—Å –µ—Å—Ç—å –ø–æ—Ö–æ–∂–∏–µ –¥–æ–º–∞ –≤ —Ç–æ–º –∂–µ —Ä–∞–π–æ–Ω–µ'")
    print()
    
    print("üîß –†–ï–®–ï–ù–ò–ï 2: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")
    print("   ‚Ä¢ –°–∫—Ä–∞–ø–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å Inmuebles24 (–≥–¥–µ —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è Century 21)")
    print("   ‚Ä¢ –°–æ–∑–¥–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥ ID –æ–±—ä–µ–∫—Ç–æ–≤ –º–µ–∂–¥—É –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏")
    print("   ‚Ä¢ –û–±–Ω–æ–≤–ª—è—Ç—å FAISS –∏–Ω–¥–µ–∫—Å—ã –æ–±–µ–∏–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏")
    print()
    
    print("üîß –†–ï–®–ï–ù–ò–ï 3: –£–º–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥")
    print("   ‚Ä¢ –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –ù–ï –∏–∑ –Ω–∞—à–µ–π –±–∞–∑—ã ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Ä–µ–∂–∏–º'")
    print("   ‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é: '–î–∞–≤–∞–π—Ç–µ –Ω–∞–π–¥–µ–º —á—Ç–æ-—Ç–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ!'")
    print("   ‚Ä¢ –°–æ–±—Ä–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è: –±—é–¥–∂–µ—Ç, —Ä–∞–π–æ–Ω, —Ç–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏")
    print()
    
    print("üîß –†–ï–®–ï–ù–ò–ï 4: –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è")
    print("   ‚Ä¢ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å URL –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –æ–±—ä–µ–∫—Ç–∞")
    print("   ‚Ä¢ –û–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ä–∞–π–æ–Ω/—Ç–∏–ø –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∏–∑ —Å—Å—ã–ª–∫–∏")
    print("   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ RAG")

def test_improved_logic():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
    print("\nüß† –¢–ï–°–¢ –£–õ–£–ß–®–ï–ù–ù–û–ô –õ–û–ì–ò–ö–ò:")
    print("=" * 60)
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
    incoming_message = """¬°Hola! Quiero que se comuniquen conmigo por este inmueble en Inmuebles24 https://www.inmuebles24.com/propiedades/clasificado/veclcapa-hermosa-casa-en-residencial-rio-cancun-146144201.html"""
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ URL
    if "residencial-rio-cancun" in incoming_message:
        extracted_info = {
            "location": "Canc√∫n",
            "area": "Residencial R√≠o",
            "property_type": "casa",
            "source": "inmuebles24"
        }
        
        print(f"üìç –ò–∑–≤–ª–µ—á–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:")
        for key, value in extracted_info.items():
            print(f"   {key}: {value}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —É–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ RAG
        smart_query = f"–ö–∞–∫–∏–µ –¥–æ–º–∞ –µ—Å—Ç—å –≤ {extracted_info['area']} –∏–ª–∏ –ø–æ—Ö–æ–∂–∏—Ö —Ä–∞–π–æ–Ω–∞—Ö –ö–∞–Ω–∫—É–Ω–∞?"
        print(f"\nüîç –£–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ RAG: {smart_query}")
        
        try:
            from core.llm_chain import llm_chain
            response = llm_chain.invoke_chain(smart_query, [])
            print(f"üí¨ –û—Ç–≤–µ—Ç: {response[:200]}...")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    test_inmuebles24_scenario()
    suggest_solutions()
    test_improved_logic()
    
    print("\nüéØ –í–´–í–û–î–´:")
    print("   1. –¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –ù–ï –≥–æ—Ç–æ–≤–∞ –∫ —Ä–µ–∞–ª—å–Ω—ã–º —Å—Ü–µ–Ω–∞—Ä–∏—è–º")
    print("   2. –ù—É–∂–Ω–∞ —É–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫")
    print("   3. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏")
    print("   4. –î–µ—Ç–µ–∫—Ü–∏—è –ª–∏–¥–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω—É–∂–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑")

if __name__ == "__main__":
    main() 